#!/bin/bash

# Pre-commit hook to prevent integration issues
# This runs before every commit to catch problems early

echo "ğŸ” Running pre-commit tests..."

# Check if we're in a merge
if git rev-parse --verify MERGE_HEAD > /dev/null 2>&1; then
    echo "âš ï¸  Merge in progress, skipping pre-commit tests"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No relevant files staged for commit"
    exit 0
fi

echo "ğŸ“ Staged files: $STAGED_FILES"

# Run linting
echo "ğŸ§¹ Running ESLint..."
npm run lint -- $STAGED_FILES
if [ $? -ne 0 ]; then
    echo "âŒ ESLint failed. Please fix linting errors before committing."
    exit 1
fi

# Run frontend and integration tests for staged files
echo "ğŸ§ª Running frontend tests..."
npm run test:frontend -- --findRelatedTests $STAGED_FILES --passWithNoTests
if [ $? -ne 0 ]; then
    echo "âŒ Frontend tests failed. Please fix failing tests before committing."
    exit 1
fi

echo "ğŸ”— Running integration tests..."
npm run test:integration -- --findRelatedTests $STAGED_FILES --passWithNoTests
if [ $? -ne 0 ]; then
    echo "âŒ Integration tests failed. Please fix failing tests before committing."
    exit 1
fi

# Check if any screen/component files are modified, run UX tests
SCREEN_FILES=$(echo "$STAGED_FILES" | grep -E '(screens|components).*\.(ts|tsx)$')
if [ ! -z "$SCREEN_FILES" ]; then
    echo "ğŸ¨ Running UX validation tests..."
    npm run test:ux -- --findRelatedTests $SCREEN_FILES --passWithNoTests
    if [ $? -ne 0 ]; then
        echo "âŒ UX validation tests failed. Please ensure proper user experience."
        exit 1
    fi
fi

echo "âœ… All pre-commit tests passed!"
exit 0