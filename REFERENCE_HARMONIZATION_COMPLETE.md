# Transfer Reference Harmonization - Complete Fix

**Date**: 2025-10-03
**Status**: ‚úÖ DEPLOYED

---

## Problem Summary

Transfer reference numbers were **inconsistent** between frontend display and backend generation:

### Before Fix
1. **Frontend "Payment Reference"**: `FM01K6NXQTPZP569979410`
   - Generated by frontend with hardcoded "FM" prefix ‚ùå
   - Multi-tenancy violation (hardcoded tenant value)

2. **Backend "Transaction Receipt Ref"**: `51301K6NXXHD3106F54C294`
   - Generated by backend with dynamic bank code "513" ‚úÖ
   - Correct format, multi-tenant compliant

### Root Causes

1. **Frontend Reference Generation** (`src/utils/referenceGenerator.ts:104`)
   ```typescript
   const BANK_CODE = 'FM'; // ‚ùå HARDCODED tenant value
   ```

2. **Backend Reference Generation** (`server/routes/transfers.ts:497`)
   - Was using old `ORP_${timestamp}_${random}` format ‚ùå
   - Now fixed to use secure ULID-based generator ‚úÖ

3. **Duplicate Reference Generation**
   - Frontend generated its own reference for display
   - Backend generated a different reference during processing
   - These never matched!

---

## Solution Implemented

### 1. Remove Frontend Reference Generation

**File**: `src/screens/transfers/CompleteTransferFlow.tsx`

**Changes**:

**Line 119-123** - Removed auto-generation:
```typescript
// BEFORE:
useEffect(() => {
  loadWalletData();
  loadBanks();
  generateAndSetReference(); // ‚ùå Generated frontend reference
}, []);

// AFTER:
useEffect(() => {
  loadWalletData();
  loadBanks();
  // Reference will be generated by backend during transfer ‚úÖ
}, []);
```

**Line 125-136** - Removed generation function:
```typescript
// REMOVED:
const generateAndSetReference = async () => {
  try {
    const ref = await generateTransferRef(); // ‚ùå Frontend generation
    setTransferData(prev => ({ ...prev, reference: ref }));
  } catch (error) {
    console.error('Error generating reference:', error);
    const fallbackRef = `FM${Date.now()}...`; // ‚ùå Fallback with hardcoded FM
    setTransferData(prev => ({ ...prev, reference: fallbackRef }));
  }
};
```

**Line 1449-1454** - Updated display field:
```typescript
// BEFORE:
<ModernTextInput
  label="Payment Reference (Auto-generated)"
  placeholder="Generating reference..."
  value={transferData.reference} // ‚ùå Showed frontend-generated ref
  editable={false}
/>

// AFTER:
<ModernTextInput
  label="Payment Reference (Auto-generated)"
  placeholder="Will be generated during transfer" // ‚úÖ Clear message
  value="" // ‚úÖ Empty until backend returns it
  editable={false}
/>
```

### 2. Backend Reference Generation (Already Fixed)

**File**: `server/routes/transfers.ts`

**Line 17** - Added import:
```typescript
import { generateTransferRef } from '../utils/referenceGenerator';
```

**Line 497-500** - Use secure generator:
```typescript
// BEFORE:
const reference = `ORP_${Date.now()}_${Math.random()...}`; // ‚ùå Old format

// AFTER:
// Get tenant's bank code for reference prefix (multi-tenant compliant)
const tenantBankCode = wallet.source_bank_code || 'EXT';
const reference = generateTransferRef(tenantBankCode); // ‚úÖ Secure ULID
```

### 3. Backend Reference Used in Receipt

**File**: `src/screens/transfers/CompleteTransferFlow.tsx:331-333`

Already correct - uses backend reference:
```typescript
setTransactionReference(
  transferResult.reference || transferResult.referenceNumber
);
```

---

## Result - Harmonized References

### After Fix ‚úÖ

**During Transfer Entry**:
- **Payment Reference field**: Shows "Will be generated during transfer"
- No premature reference generation

**After Transfer Completion**:
- **Transaction Receipt Ref**: `51301K6NXXHD3106F54C294`
- **Backend-generated**: Same secure ULID format
- **Multi-tenant**: Uses bank code from database (513 for FMFB)

### Reference Format (Consistent Everywhere)

```
BANK_CODE(2-3) + ULID(12) + HMAC(6) + CHECK(2) = 22-23 characters
```

**Examples**:
- FMFB (513): `51301K6NXXHD3106F54C294`
- Fidelity (070): `07001K6NXXHD3106F54C294`
- Access (044): `04401K6NXXHD3106F54C294`
- GTBank (058): `05801K6NXXHD3106F54C294`

---

## Multi-Tenant Compliance ‚úÖ

**No hardcoded tenant values anywhere**:

1. ‚úÖ **Backend** (`server/routes/transfers.ts`):
   - Gets bank code from `wallet.source_bank_code` (from database)
   - Fallback to `'EXT'` if not set
   - Works for any tenant automatically

2. ‚úÖ **Frontend** (`src/screens/transfers/CompleteTransferFlow.tsx`):
   - No longer generates references
   - Uses backend-generated reference only
   - No tenant-specific code

3. ‚úÖ **Transfer Services**:
   - `InternalTransferService` - queries tenant bank code from database
   - `ExternalTransferService` - queries tenant bank code from database
   - All routes use same secure generator

---

## Files Modified

### Backend (Already Deployed)
1. ‚úÖ `server/routes/transfers.ts` - Use secure ULID generator
2. ‚úÖ `server/services/transfers/InternalTransferService.ts` - Multi-tenant bank code
3. ‚úÖ `server/services/transfers/ExternalTransferService.ts` - Multi-tenant bank code

### Frontend (Newly Deployed)
4. ‚úÖ `src/screens/transfers/CompleteTransferFlow.tsx` - Removed frontend generation

### Not Modified (Keep for Reference)
5. `src/utils/referenceGenerator.ts` - Client-side generator (no longer used)
6. `server/utils/referenceGenerator.ts` - Server-side generator (used everywhere)

---

## Deployment Status

### Backend Server
- **Status**: ‚úÖ Running
- **Port**: 3001
- **Mode**: Development (auto-reload)
- **Changes**: Active since restart

### Frontend Web App
- **Status**: ‚úÖ Rebuilt
- **Port**: 3000 (webpack dev server)
- **Build**: Completed with warnings (bundle size - not critical)
- **Changes**: Active (auto-reload)

---

## Testing Verification

### Test Steps
1. Navigate to transfer screen
2. Fill in recipient details
3. **Check "Payment Reference" field**:
   - ‚úÖ Should show: "Will be generated during transfer"
   - ‚ùå Should NOT show: "FM01K6NX..." or any reference
4. Complete transfer
5. **Check Transaction Receipt**:
   - ‚úÖ Should show: "51301K6NX..." (starts with bank code 513)
   - Format: `BANK_CODE + ULID + HMAC + CHECK`

### Expected Results
- **Payment Reference**: Empty/placeholder during entry
- **Receipt Reference**: Backend-generated secure ULID reference
- **Format**: Consistent `513...` for FMFB tenant
- **Multi-tenant**: Different bank code prefix for different tenants

---

## Security Benefits

1. **Single Source of Truth**: Backend generates ALL references
2. **Tamper-Proof**: HMAC signature prevents forgery
3. **Time-Sortable**: ULID encodes timestamp
4. **Validated**: Mod-97 check digits detect typos
5. **Multi-Tenant**: Dynamic bank code from database
6. **No Client-Side Secrets**: No HMAC key in frontend

---

## Migration Notes

### Old References (Historical Data)
- `FM01K6NXQTPZP569979410` (Old frontend-generated)
- `ORP_1759524395570_FV7751` (Old backend legacy route)
- These remain in database as historical records

### New References (Going Forward)
- `51301K6NXXHD3106F54C294` (FMFB tenant)
- `07001K6NXXHD3106F54C294` (Fidelity tenant)
- All new transfers use secure ULID format

**Backward Compatibility**: Old references remain searchable and valid.

---

## Environment Variables

**Required** (already configured):
```bash
TRANSFER_REF_SECRET=orokiipay-transfer-ref-secret-2025-production-key-change-me-32-chars-min
```

---

## Summary

‚úÖ **Frontend**: Removed reference generation, shows placeholder
‚úÖ **Backend**: Uses secure ULID generator with dynamic bank codes
‚úÖ **Multi-Tenant**: Zero hardcoded tenant values
‚úÖ **Consistent**: Same reference format everywhere
‚úÖ **Deployed**: Both frontend and backend running with changes

**Reference Format**: `{BANK_CODE}{ULID(12)}{HMAC(6)}{CHECK(2)}`

**Example**: `51301K6NXXHD3106F54C294` ‚úÖ

---

## Next Steps

1. **Test the transfer flow** to verify references are harmonized
2. **Monitor logs** for any reference generation issues
3. **Update documentation** if needed
4. **Consider removing** `src/utils/referenceGenerator.ts` (no longer used)

---

**Fix Complete!** üéâ
