# Migration Guide: New Transfer Service Architecture

**Date**: 2025-10-03
**Status**: READY TO IMPLEMENT

---

## Overview

Migrate from **legacy unified route** to **dedicated service routes** for better separation of concerns and proper data storage.

### Current State ‚ùå
```
Frontend ‚Üí POST /api/transfers/initiate (legacy)
           ‚Üì
        All transfers ‚Üí tenant.transfers table
        No proper type differentiation
        No wallet_transactions audit trail
```

### Target State ‚úÖ
```
Internal Transfer:
Frontend ‚Üí POST /api/transfers/internal
           ‚Üì
        InternalTransferService
           ‚Üì
        tenant.internal_transfers table
        tenant.wallet_transactions (debit/credit)

External Transfer:
Frontend ‚Üí POST /api/transfers/external
           ‚Üì
        ExternalTransferService
           ‚Üì
        tenant.transfers table
        Proper NIBSS integration
```

---

## Step 1: Fix Backend Routes

### 1.1 Fix `/internal` Route Reference Generation

**File**: `server/routes/transfers.ts`

**Current (Line 963)** ‚ùå:
```typescript
const request: InternalTransferRequest = {
  fromWalletId: fromWalletId,
  toWalletId: toWalletId,
  amount: parseFloat(req.body.amount),
  currency: 'NGN',
  narration: req.body.description || 'Internal transfer',
  reference: `INT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`  // ‚ùå Legacy format
};
```

**Fix**:
```typescript
const request: InternalTransferRequest = {
  fromWalletId: fromWalletId,
  toWalletId: toWalletId,
  amount: parseFloat(req.body.amount),
  currency: 'NGN',
  narration: req.body.description || 'Internal transfer',
  // ‚úÖ Reference will be generated by InternalTransferService with tenant bank code
};
```

**Reasoning**: InternalTransferService already generates secure ULID-based references internally. Don't override it.

---

## Step 2: Add New APIService Methods

**File**: `src/services/api.ts`

Add after the existing `initiateTransfer` method (around line 500):

```typescript
/**
 * Process internal/same-bank transfer
 */
async processInternalTransfer(transferData: {
  recipientAccountNumber: string;
  recipientName?: string;
  amount: number;
  description?: string;
  pin: string;
}): Promise<{
  success: boolean;
  reference: string;
  id?: string;
  amount: number;
  status: string;
  recipient?: {
    name: string;
    accountNumber: string;
  };
  message?: string;
}> {
  const response = await this.makeRequest<any>('transfers/internal', {
    method: 'POST',
    body: JSON.stringify(transferData)
  });

  if (response.success && response.data) {
    return {
      success: true,
      reference: response.data.reference,
      id: response.data.id,
      amount: response.data.amount,
      status: response.data.status,
      recipient: {
        name: transferData.recipientName || '',
        accountNumber: transferData.recipientAccountNumber
      },
      message: response.message
    };
  }

  throw new Error(response.error || 'Internal transfer failed');
}

/**
 * Process external/inter-bank transfer
 */
async processExternalTransfer(transferData: {
  recipientAccountNumber: string;
  recipientBankCode: string;
  recipientName?: string;
  amount: number;
  description?: string;
  pin: string;
  saveBeneficiary?: boolean;
  beneficiaryNickname?: string;
}): Promise<{
  success: boolean;
  reference: string;
  id?: string;
  amount: number;
  status: string;
  recipient?: {
    name: string;
    accountNumber: string;
    bankCode: string;
  };
  message?: string;
}> {
  const response = await this.makeRequest<any>('transfers/external', {
    method: 'POST',
    body: JSON.stringify(transferData)
  });

  if (response.success && response.data) {
    return {
      success: true,
      reference: response.data.reference,
      id: response.data.id,
      amount: response.data.amount,
      status: response.data.status,
      recipient: {
        name: transferData.recipientName || '',
        accountNumber: transferData.recipientAccountNumber,
        bankCode: transferData.recipientBankCode
      },
      message: response.message
    };
  }

  throw new Error(response.error || 'External transfer failed');
}
```

---

## Step 3: Update Frontend Transfer Logic

**File**: `src/screens/transfers/CompleteTransferFlow.tsx`

**Current (Lines 295-380)** - Replace entire `handleProcessTransfer` function:

```typescript
const handleProcessTransfer = async () => {
  const errors = validateReviewStep();
  if (errors.length > 0) {
    notify.error(errors.join('\n'), 'Validation Error');
    return;
  }

  setIsProcessing(true);

  try {
    console.log('üí∞ Initiating transfer via API...');

    // Determine transfer type based on bank code
    const isSameBank = actualTransferType === 'internal' || actualTransferType === 'same-bank';
    const bankCode = isSameBank ? (tenantInfo.bankCode || '') : transferData.bank;

    let transferResult;

    if (isSameBank) {
      // ‚úÖ Use new internal transfer service
      console.log('üè¶ Processing same-bank transfer via InternalTransferService...');
      transferResult = await APIService.processInternalTransfer({
        recipientAccountNumber: transferData.accountNumber,
        recipientName: transferData.accountName,
        amount: parseFloat(transferData.amount.replace(/,/g, '')),
        description: transferData.narration || 'Internal Transfer',
        pin: transferData.pin,
      });
    } else {
      // ‚úÖ Use new external transfer service
      console.log('üåç Processing inter-bank transfer via ExternalTransferService...');
      transferResult = await APIService.processExternalTransfer({
        recipientAccountNumber: transferData.accountNumber,
        recipientBankCode: bankCode,
        recipientName: transferData.accountName,
        amount: parseFloat(transferData.amount.replace(/,/g, '')),
        description: transferData.narration || 'External Transfer',
        pin: transferData.pin,
      });
    }

    console.log('‚úÖ Transfer API response:', transferResult);

    // Set transaction reference from API response
    if (!transferResult.reference) {
      console.error('‚ùå Transfer API did not return a reference number!', transferResult);
      throw new Error('Transfer completed but no reference number was returned. Please contact support.');
    }

    setTransactionReference(transferResult.reference);

    // Check if transfer was successful
    if (
      transferResult.status === 'successful' ||
      transferResult.status === 'completed' ||
      transferResult.status === 'success'
    ) {
      console.log('üéâ Transfer completed successfully!');

      // Move to success page
      setCurrentStep('complete');

      // Show success notification
      const recipientName = transferResult.recipient?.name || transferData.accountName;

      notify.success(
        isSameBank
          ? `${formatCurrencyUtil(transferResult.amount, theme.currency)} transferred instantly to ${recipientName} (${tenantInfo.name} Account) - FREE!`
          : `${formatCurrencyUtil(transferResult.amount, theme.currency)} sent to ${recipientName}`,
        isSameBank ? 'Same Bank Transfer Successful! üéâ' : 'Transfer Successful! üéâ'
      );
    } else if (transferResult.status === 'pending' || transferResult.status === 'processing') {
      // Transfer is pending/processing (external NIBSS transfers)
      console.log('‚è≥ Transfer is being processed via NIBSS...');
      setCurrentStep('complete');
      notify.warning(
        'Your transfer is being processed. You will receive a notification when completed.',
        'Transfer Processing'
      );
    } else {
      // Transfer failed
      throw new Error(transferResult.message || 'Transfer failed');
    }
  } catch (error: any) {
    console.error('‚ùå Transfer failed:', error);

    // Show detailed error message
    const errorMessage = error.message ||
      error.error ||
      'Transfer failed. Please try again or contact support.';

    notify.error(errorMessage, 'Transfer Failed');
  } finally {
    setIsProcessing(false);
  }
};
```

---

## Step 4: Remove Legacy Reference Generation from `/internal` Route

**File**: `server/routes/transfers.ts`

**Line 957-964**:

```typescript
// BEFORE:
const request: InternalTransferRequest = {
  fromWalletId: fromWalletId,
  toWalletId: toWalletId,
  amount: parseFloat(req.body.amount),
  currency: 'NGN',
  narration: req.body.description || 'Internal transfer',
  reference: `INT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`  // ‚ùå REMOVE
};

// AFTER:
const request: InternalTransferRequest = {
  fromWalletId: fromWalletId,
  toWalletId: toWalletId,
  amount: parseFloat(req.body.amount),
  currency: 'NGN',
  narration: req.body.description || 'Internal transfer',
  // Reference will be generated by InternalTransferService ‚úÖ
};
```

---

## Benefits After Migration

### 1. ‚úÖ Proper Table Separation

| Transfer Type | Table | Reference Format |
|--------------|-------|------------------|
| **Internal/Same-Bank** | `tenant.internal_transfers` | `51301K6NX5EWSYR0994CE71` |
| **External/Inter-Bank** | `tenant.transfers` | `51301K6NX5EWSYR0994CE71` |

### 2. ‚úÖ Complete Audit Trail

**Internal Transfers** create records in:
- `tenant.internal_transfers` (main record)
- `tenant.wallet_transactions` (debit)
- `tenant.wallet_transactions` (credit)
- `tenant.transactions` (unified ledger)

**External Transfers** create records in:
- `tenant.transfers` (main record)
- `tenant.transactions` (unified ledger)

### 3. ‚úÖ Consistent Reference Format

All transfers use secure ULID-based generator:
```
BANK_CODE(2-3) + ULID(12) + HMAC(6) + CHECK(2)
```

### 4. ‚úÖ Better Query Performance

```sql
-- Get all internal transfers (optimized)
SELECT * FROM tenant.internal_transfers WHERE tenant_id = $1;

-- Get all external transfers (optimized)
SELECT * FROM tenant.transfers WHERE tenant_id = $1;

-- vs OLD: Get all transfers (mixed, needs filtering)
SELECT * FROM tenant.transfers WHERE tenant_id = $1
  AND (source_bank_code = recipient_bank_code OR recipient_user_id IS NOT NULL);
```

---

## Testing Checklist

### Internal Transfer Test
1. ‚úÖ Navigate to transfer screen
2. ‚úÖ Select same-bank recipient (bank code matches tenant)
3. ‚úÖ Complete transfer
4. ‚úÖ **Verify**: Reference starts with bank code (e.g., `513...`)
5. ‚úÖ **Verify**: Record in `tenant.internal_transfers`
6. ‚úÖ **Verify**: Debit/credit in `tenant.wallet_transactions`
7. ‚úÖ **Verify**: Receipt shows same reference

### External Transfer Test
1. ‚úÖ Navigate to transfer screen
2. ‚úÖ Select different bank recipient
3. ‚úÖ Complete transfer
4. ‚úÖ **Verify**: Reference starts with bank code (e.g., `513...`)
5. ‚úÖ **Verify**: Record in `tenant.transfers`
6. ‚úÖ **Verify**: Status is `pending` (NIBSS processing)
7. ‚úÖ **Verify**: Receipt shows same reference

---

## Migration Strategy

### Option A: Hard Cutover (Recommended)
1. Deploy all changes at once
2. Test thoroughly
3. Monitor for 24 hours

### Option B: Gradual Rollout
1. Deploy backend changes first
2. Keep legacy route active
3. Update frontend to use new routes
4. Monitor both routes
5. Deprecate legacy route after 1 week

### Option C: Feature Flag
1. Add environment variable `USE_NEW_TRANSFER_SERVICES=true`
2. Frontend checks flag and routes accordingly
3. Gradually enable for users
4. Full rollout after testing

---

## Rollback Plan

If issues arise, rollback is simple:

**Frontend**: Revert `CompleteTransferFlow.tsx` to call `initiateTransfer()`
**Backend**: Legacy route `/api/transfers/initiate` remains functional

No database changes required - both systems can coexist.

---

## Summary of Changes

### Backend (2 files)
1. ‚úÖ `server/routes/transfers.ts` - Remove legacy reference from `/internal` route

### Frontend (2 files)
1. ‚úÖ `src/services/api.ts` - Add `processInternalTransfer()` and `processExternalTransfer()`
2. ‚úÖ `src/screens/transfers/CompleteTransferFlow.tsx` - Update `handleProcessTransfer()` logic

### Total Changes: 3 files, ~150 lines of code

---

## Next Steps

1. **Review** this migration guide
2. **Approve** the approach
3. **Implement** changes (I can do this for you)
4. **Test** both transfer types
5. **Monitor** transfer success rates
6. **Deprecate** legacy route after 1 week

Ready to proceed? üöÄ
